{% extends "base.html" %}

{% block title %}Pickup Code Scanner{% endblock title %}

{% block content %}
<div class="max-w-xl mx-auto bg-white p-8 rounded-xl shadow-2xl border border-gray-200">
    <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Real-Time Pickup Verification</h1>
    <p class="text-gray-600 mb-6">Scan (or type) the Parent's code to instantly verify student pickup.</p>
    
    <div id="status-display" class="p-4 mb-6 text-center text-lg font-semibold rounded-lg bg-yellow-100 text-yellow-700">
        Waiting for Connection...
    </div>

    <form id="scanner-form" class="space-y-4">
        <label for="code-input" class="block text-sm font-medium text-gray-700">Enter Code (Simulate Scan):</label>
        <input type="text" id="code-input" placeholder="e.g., 1a2b3c4d-..." 
               class="w-full p-3 border-2 border-gray-300 rounded-lg text-xl focus:border-blue-500 focus:ring-blue-500" required>
        <button type="submit" 
                class="w-full px-4 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition">
            Verify Code
        </button>
    </form>
</div>
{% endblock content %}

{% block extra_js %}
<script>
    const wsUrl = "{{ ws_url }}".replace('http', 'ws');
    const statusDisplay = document.getElementById('status-display');
    const scannerForm = document.getElementById('scanner-form');
    const codeInput = document.getElementById('code-input');
    
    const socket = new WebSocket(wsUrl);

    socket.onopen = function() {
        statusDisplay.textContent = 'Scanner Ready: Connected ðŸŸ¢';
        statusDisplay.className = 'p-4 mb-6 text-center text-lg font-semibold rounded-lg bg-green-100 text-green-700';
    };

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        let message = data.message;
        let cssClass;

        if (data.status === 'success') {
            cssClass = 'p-4 mb-6 text-center text-lg font-bold rounded-lg bg-green-500 text-white';
        } else {
            cssClass = 'p-4 mb-6 text-center text-lg font-bold rounded-lg bg-red-500 text-white';
        }
        
        statusDisplay.textContent = message;
        statusDisplay.className = cssClass;

        // Clear input after verification
        setTimeout(() => {
             codeInput.value = '';
             statusDisplay.textContent = 'Ready for Next Scan...';
             statusDisplay.className = 'p-4 mb-6 text-center text-lg font-semibold rounded-lg bg-blue-100 text-blue-700';
        }, 5000);
    };

    socket.onclose = function() {
        statusDisplay.textContent = 'Connection Lost ðŸ”´. Reloading...';
        statusDisplay.className = 'p-4 mb-6 text-center text-lg font-semibold rounded-lg bg-red-100 text-red-700';
    };

    scannerForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const code = codeInput.value.trim();
        if (socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ 'code': code }));
            statusDisplay.textContent = 'Verifying...';
            statusDisplay.className = 'p-4 mb-6 text-center text-lg font-semibold rounded-lg bg-yellow-100 text-yellow-700';
        } else {
            alert("WebSocket is not connected. Please reload the page.");
        }
    });
</script>
{% endblock extra_js %}