{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">

  <h4 class="mb-4">
    Products for {{ ward.get_full_name }} ({{ ward.student_class }})
  </h4>

  <div class="row g-4">
    {% for product in products %}
      <div class="col-md-4 col-lg-3">
        <div class="card h-100 shadow-sm">

          <!-- Product Image -->
          <div class="ratio ratio-4x3">
            {% if product.image %}
              <img
                src="{{ product.image.url }}"
                class="card-img-top object-fit-cover"
                alt="{{ product.name }}"
              >
            {% else %}
              <img
                src="{% static 'images/default_product.png' %}"
                class="card-img-top object-fit-cover"
                alt="No image"
              >
            {% endif %}
          </div>

          <div class="card-body d-flex flex-column">
            <h6 class="fw-semibold mb-1">{{ product.name }}</h6>

            <small class="text-muted mb-2">
              ₦{{ product.price }}
            </small>

            <div class="mt-auto">
              {% if product.id in cart_product_ids %}
                <button class="btn btn-secondary w-100" disabled>
                  Already in Cart
                </button>
              {% else %}
                <button
                  class="btn btn-primary w-100 add-to-cart-btn"
                  data-product-id="{{ product.id }}"
                >
                  Add to Cart
                </button>
              {% endif %}
            </div>
          </div>

        </div>
      </div>
    {% empty %}
      <p class="text-muted">No products available.</p>
    {% endfor %}
  </div>

  <!-- CART SIDEBAR -->
<div id="cart-sidebar" class="cart-sidebar">
  <div class="cart-header d-flex justify-content-between align-items-center">
    <h6 class="mb-0">Your Cart</h6>
    <button class="btn btn-sm btn-outline-secondary" onclick="closeCart()">✕</button>
  </div>

  <div id="cart-body" class="cart-body">
    <p class="text-muted text-center mt-4">Loading cart…</p>
  </div>
</div>

  <style>
  .cart-sidebar {
    position: fixed;
    top: 0;
    right: -380px;
    width: 360px;
    height: 100vh;
    background: #fff;
    box-shadow: -8px 0 30px rgba(0,0,0,.15);
    z-index: 1050;
    display: flex;
    flex-direction: column;
    transition: right .35s ease;
  }

  .cart-sidebar.open {
    right: 0;
  }

  .cart-header {
    padding: 16px;
    border-bottom: 1px solid #eee;
  }

  .cart-body {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
  }
</style>


</div>

<script>


function loadCart() {
  const ward = "{{ ward.id }}";
  fetch(`/brillspay/cart/sidebar/?ward=${ward}`)
    .then(res => res.text())
    .then(html => {
      document.getElementById("cart-body").innerHTML = html;
      refreshCartCount();
    });
}

// Open Sidebar
function openCart() {
  const sidebar = document.getElementById("cart-sidebar");
  sidebar.classList.add("open");
  loadCart();   
}

// Close Sidebar
function closeCart() {
  document.getElementById("cart-sidebar").classList.remove("open");
}

//Cart count Update
function refreshCartCount() {
  fetch(`/brillspay/cart/count/?ward={{ ward.id }}`)
    .then(res => res.json())
    .then(data => {
      document.getElementById("cart-count").innerText = data.count;
    });
}

document.addEventListener("click", function (e) {

  // Add to cart
  if (e.target.classList.contains("add-to-cart-btn")) {
    fetch("{% url 'brillspay:brillspay_add_to_cart' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: `product_id=${e.target.dataset.productId}&ward_id={{ ward.id }}`
    }).then(() => {
      e.target.disabled = true;
      e.target.innerText = "In Cart";
      openCart();
      loadCart();
      refreshCartCount();
    });
  }

  // Quantity buttons
  if (e.target.classList.contains("qty-btn")) {
    fetch("{% url 'brillspay:brillspay_update_cart_item' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: `item_id=${e.target.dataset.item}&action=${e.target.dataset.action}`
    }).then(() => {
      loadCart();
      refreshCartCount();
    });
  }

  if (e.target.classList.contains("remove-item")) {
    fetch("{% url 'brillspay:brillspay_update_cart_item' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: `item_id=${e.target.dataset.item}&action=remove`
    }).then(() => {
      loadCart();
      refreshCartCount();
    });
  }

});

</script>

{% endblock %}