{% extends "base.html" %}
{% load static %}
{% block title %}Payment Status{% endblock %}

{% block content %}
<div class="container py-5 text-center">
    <h3>Payment Status</h3>

    <div id="success" class="my-4"></div>
    <p id="status-text">Verifying payment...</p>

    <div id="spinner" class="my-4">
        <img src="{% static 'images/spinner.gif' %}" alt="Loading..." width="100" height="70">
    </div>

    <a id="continue-btn"
       href="{% url 'brillspay:brillspay_select_ward' %}"
       class="btn btn-primary mt-3 d-none">
        Buy more
    </a>
</div>

<script>
const reference = "{{ transaction.gateway_reference|default:'' }}";

if (!reference) {
    document.getElementById("status-text").innerText = "Invalid transaction reference ❌";
    document.getElementById("spinner").style.display = "none";
    document.getElementById("continue-btn").classList.remove("d-none");
    throw new Error("Missing transaction reference");
}

let attempts = 0;
const MAX_ATTEMPTS = 10; // 10 × 3s = 30 seconds max

function stopPolling() {
    clearInterval(interval);
    document.getElementById("spinner").style.display = "none";
    document.getElementById("continue-btn").classList.remove("d-none");
}

function checkPayment() {
    attempts++;

    fetch("{% url 'brillspay:payment_status_check' %}?ref=" + reference)
        .then(res => res.json())
        .then(data => {
            const successEl = document.getElementById("success");
            const statusEl = document.getElementById("status-text");

            if (data.verified === true) {
                successEl.innerHTML =
                    `<img src="https://cdn.dribbble.com/userupload/15097592/file/original-11af0dab65a0913fe4ea1d71d9d48f4a.gif" alt="success" width="120">`;
                statusEl.innerText = "Payment Successful ";
                stopPolling();

                // optional auto-redirect after 3s
                setTimeout(() => {
                    window.location.href =
                        "{% url 'brillspay:brillspay_select_ward' %}";
                }, 3000);
            }
            else if (data.status === "failed") {
                statusEl.innerText = "Payment Failed ❌";
                stopPolling();
            }
            else if (data.status === "abandoned") {
                statusEl.innerText = "Payment Abandoned ⚠️";
                stopPolling();
            }
            else if (attempts >= MAX_ATTEMPTS) {
                statusEl.innerText =
                    "Payment verification delayed. Please refresh or check later.";
                stopPolling();
            }
            else {
                statusEl.innerText = "Verifying payment...";
            }
        })
        .catch(err => {
            console.error(err);
            document.getElementById("status-text").innerText =
                "Network error while verifying payment.";
            stopPolling();
        });
}

// poll every 3 seconds
const interval = setInterval(checkPayment, 3000);

// run immediately once
checkPayment();
</script>
{% endblock %}
