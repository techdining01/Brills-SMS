{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>BrillsPay Store</h3>
        <a href="{% url 'brillspay:cart' %}" class="position-relative btn btn-outline-primary">
            Cart
            <span id="cart-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                {{ cart_count }}
            </span>
        </a>
    </div>

    <div class="row g-4">
        {% for product in products %}
        <div class="col-6 col-md-4 col-lg-3">
            <div class="card shadow-sm h-100">
                {% if product.image %}
                <img src="{{ product.image.url }}" class="card-img-top" style="height:200px; object-fit:cover;">
                {% endif %}
                <div class="card-body d-flex flex-column">
                    <h6 class="card-title">{{ product.name }}</h6>
                    <p class="fw-bold text-success">â‚¦{{ product.price }}</p>
                    
                    {% if wards %}
                    <select class="form-select mb-2 ward-select" data-id="{{ product.id }}">
                        <option value="">Select Ward</option>
                        {% for ward in wards %}
                            {% if ward.student_class %}
                            <option value="{{ ward.id }}">
                                {{ ward.get_full_name }} ({{ ward.student_class }})
                            </option>
                            {% endif %}
                        {% endfor %}
                    </select>
                    {% else %}
                    <p class="text-muted small">No wards linked</p>
                    {% endif %}

                    <button class="btn btn-primary mt-auto add-cart" data-id="{{ product.id }}">
                        Add to Cart
                    </button>
                </div>
            </div>
        </div>
        {% empty %}
        <p class="text-muted">No products available for your wards' classes.</p>
        {% endfor %}
    </div>
</div>

<script>
document.querySelectorAll('.add-cart').forEach(btn => {
    btn.onclick = async () => {
        const wardSelect = btn.closest('.card-body').querySelector('.ward-select');
        const wardId = wardSelect.value;
        if (!wardId) {
            alert('Please select a ward.');
            return;
        }

        const res = await fetch("{% url 'brillspay:add_to_cart' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `product_id=${btn.dataset.id}&ward_id=${wardId}`
        });

        const data = await res.json();
        if (data.success) {
            const badge = document.getElementById('cart-badge');
            badge.textContent = data.cart_count;
        } else {
            alert(data.message || 'Error adding to cart.');
        }
    }
});
</script>
{% endblock %}
