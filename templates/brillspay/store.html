{% extends "base.html" %}
{% load static %}

{% block content %}
<h3>Products for {{ ward.get_full_name }}</h3>

<div class="row">
  {% for product in products %}
    <div class="col-md-4 mb-3">
      <div class="card h-100">
        <div class="card-body">
          <h5>{{ product.name }}</h5>
          <p>â‚¦{{ product.price }}</p>

          <button
            class="btn btn-primary add-to-cart-btn"
            data-product="{{ product.id }}"
            {% if product.id in cart_product_ids %}disabled{% endif %}
          >
            {% if product.id in cart_product_ids %}
              In Cart
            {% else %}
              Add to Cart
            {% endif %}
          </button>
        </div>
      </div>
    </div>
  {% endfor %}
</div>

<script>
document.querySelectorAll(".add-to-cart-btn").forEach(btn => {
  btn.addEventListener("click", function () {
    const productId = this.dataset.product;

    fetch("{% url 'brillspay:brillspay_add_to_cart' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: new URLSearchParams({
        product_id: productId,
        ward_id: "{{ ward.id }}"
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === "added") {
        this.disabled = true;
        this.innerText = "In Cart";

        // ðŸ”” update sidebar count if present
        const badge = document.getElementById("cart-count");
        if (badge) badge.innerText = data.cart_count;
      }
    });
  });
});
</script>
{% endblock %}
