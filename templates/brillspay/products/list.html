{% extends "base.html" %}
{% load static %}

{% block title %}BrillsPay Products{% endblock %}

{% block content %}
<div class="container py-5">

  <!-- Page Header -->
  <div class="text-center mb-5">
    <h2 class="fw-bold">School Store</h2>
    <p class="text-muted">
      Select items applicable to your ward’s class
    </p>
    <form method="get" class="d-flex justify-content-end mb-4">
  <select
    name="class"
    class="form-select w-auto"
    onchange="this.form.submit()"
  >
    <option value="">All Classes</option>
    {% for c in classes %}
      <option value="{{ c }}"
        {% if request.GET.class == c %}selected{% endif %}
      >
        {{ c }}
      </option>
    {% endfor %}
  </select>
</form>

  </div>

  <!-- Product Grid -->
  <div class="row g-4">

    <div id="skeleton" class="row g-4">
      {% for i in "1234" %}
      <div class="col-md-3">
        <div class="placeholder-glow">
          <div class="placeholder col-12" style="height:200px"></div>
          <div class="placeholder col-6 mt-2"></div>
        </div>
      </div>
      {% endfor %}
    </div>

    {% for product in products %}
    <div class="col-xl-3 col-lg-4 col-md-6">
      <div class="product-card h-100">

        <!-- Image -->
        <div class="product-image-wrapper">
          {% if product.image %}
            <img src="{{ product.image.url }}" alt="{{ product.name }}">
          {% else %}
            <img src="{% static 'images/product-default.png' %}" alt="No image">
          {% endif %}

          {% if product.stock_quantity <= 0 %}
            <span class="badge bg-danger stock-badge">Out of Stock</span>
          {% else %}
            <span class="badge bg-success stock-badge">In Stock</span>
          {% endif %}
        </div>

        <!-- Content -->
        <div class="p-3">

          <h6 class="fw-semibold mb-1">
            {{ product.name }}
          </h6>

          <small class="text-muted d-block mb-2">
            Class: {{ product.school_class }}
          </small>

          <div class="d-flex justify-content-between align-items-center mt-3">
            <span class="price">
              ₦{{ product.price|floatformat:2 }}
            </span>

            {% if product.stock_quantity > 0 %}
              <button
                class="btn btn-sm btn-primary add-to-cart-btn"
                data-product-id="{{ product.id }}">
                Add to Cart
              </button>
            {% else %}
              <button class="btn btn-sm btn-secondary" disabled>
                Unavailable
              </button>
            {% endif %}
          </div>

        </div>

      </div>
    </div>
    {% empty %}
      <div class="col-12 text-center text-muted">
        No products available for this class.
      </div>
    {% endfor %}

  </div>
</div>

<!-- Smooth UI Styles -->
<style>
.product-card {
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 10px 25px rgba(0,0,0,.05);
  overflow: hidden;
  transition: all .35s ease;
}

.product-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 20px 40px rgba(0,0,0,.12);
}

.product-image-wrapper {
  position: relative;
  height: 200px;
  overflow: hidden;
}

.product-image-wrapper img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform .4s ease;
}

.product-card:hover img {
  transform: scale(1.08);
}

.stock-badge {
  position: absolute;
  top: 12px;
  left: 12px;
  font-size: .75rem;
  padding: .4em .6em;
  border-radius: 20px;
}

.price {
  font-weight: 700;
  font-size: 1.1rem;
}

.add-to-cart-btn {
  border-radius: 20px;
  padding: .35rem .9rem;
  transition: background .3s ease, transform .2s ease;
}

.add-to-cart-btn:hover {
  transform: scale(1.05);
}
</style>

<!-- Add to Cart AJAX -->
<script>
document.querySelectorAll(".add-to-cart-btn").forEach(btn => {
  btn.addEventListener("click", function () {
    const productId = this.dataset.productId;

    fetch("{% url 'brillspay:add_to_cart' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        product_id: productId
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.error) {
        alert(data.error);
      } else {
        this.innerText = "Added ✓";
        this.disabled = true;
      }
    });
  });
});

window.addEventListener("load", () => {
  document.getElementById("skeleton")?.remove();
});

</script>
{% endblock %}
