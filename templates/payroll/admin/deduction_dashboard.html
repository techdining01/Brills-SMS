{% extends "base.html" %}
{% load humanize %}

{% block content %}
<div class="container py-4">

  <h4 class="mb-3">Salary Deductions & Earnings</h4>

  <div class="table-responsive">
    <table class="table table-striped align-middle">
      <thead>
        <tr>
          <th>Period</th>
          <th>Component</th>
          <th>Type</th>
          <th class="text-end">Amount (â‚¦)</th>
        </tr>
      </thead>
      <tbody>
        {% for item in records %}
        <tr>
          <td>
            {{ item.payroll_record.payroll_period.month }}/{{ item.payroll_record.payroll_period.year }}
          </td>
          <td>{{ item.component.name }}</td>
          <td>
            <span class="badge {% if item.line_type == 'deduction' %}bg-danger{% else %}bg-success{% endif %}">
              {{ item.line_type|title }}
            </span>
          </td>
          <td class="text-end">
            {{ item.amount|intcomma }}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="4" class="text-center text-muted">
            No records available
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <hr>

  <h5 class="mt-4">Monthly Deduction Trend</h5>
  <canvas id="deductionChart"></canvas>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
fetch("/payroll/admin/charts/deductions/")
  .then(res => res.json())
  .then(data => {
    const labels = [...new Set(data.map(
      d => `${d.payroll_record__payroll_period__month}/${d.payroll_record__payroll_period__year}`
    ))];

    const totals = labels.map(label =>
      data
        .filter(d => `${d.payroll_record__payroll_period__month}/${d.payroll_record__payroll_period__year}` === label)
        .reduce((sum, d) => sum + d.total, 0)
    );

    new Chart(document.getElementById("deductionChart"), {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "Total Deductions",
          data: totals,
          tension: 0.4
        }]
      }
    });
  });
</script>
{% endblock %}
