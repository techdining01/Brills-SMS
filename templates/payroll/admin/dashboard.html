{% extends "base.html" %}
{% load humanize %}

{% block content %}

<div class="container-fluid py-4" >

  <div class="d-flex justify-content-between align-item center mb-4">
    <h4 class="mb-3">Payroll Control Panel</h4> 
    <div>
      <a href="#" class="btn btn-outline-primary btn-sm" >Generate Payroll</a>
      <a href="#" class="btn btn-outline-info btn-sm" >Enrol payee</a>
      <a href="#" class="btn btn-outline-warning btn-sm" >Deduction</a>
      <a href="{% url 'loans:admin_loan_list' %}" class="btn btn-outline-danger btn-sm" >Loan</a>
    </div>
   
  </div>

  <!-- Stats -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card shadow-sm">
        <div class="card-body">
          <small>Total Payees</small>
          <h5>{{ stats.payees }}</h5>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card shadow-sm">
        <div class="card-body">
          <small>Pending Payrolls</small>
          <h5 class="text-warning">{{ stats.pending }}</h5>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card shadow-sm">
        <div class="card-body">
          <small>Approved Payrolls</small>
          <h5 class="text-success">{{ stats.approved }}</h5>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card shadow-sm">
        <div class="card-body">
          <small>Total Net Pay</small>
          <h5>₦{{ stats.total_net|intcomma }}</h5>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Payroll -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-white">
      <strong>Recent Payroll Records</strong>
    </div>

    <div class="card shadow-sm">
      <div class="card-body table-responsive">
          <table class="table table-striped table-hover align-middle">
            <thead>
              <tr>
                <th>Staff</th>
                <th>Period</th>
                <th>Net Pay</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for p in recent_payrolls %}
              <tr>
                <td>{{ p.payee.full_name }}</td>
                <td>{{ p.payroll_period }}</td>
                <td>₦{{ p.net_pay|intcomma }}</td>
                <td>
                  {% if p.status == "approved" %}
                    <span class="badge bg-success">Approved</span>
                  {% else %}
                    <span class="badge bg-warning">Pending</span>
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="4" class="text-center text-muted py-3">
                  No records yet
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

  <!-- Payroll periods -->
  <div class="card shadow-sm">
    <div class="card-header bg-white">
      <strong>Payroll Periods</strong>
    </div>

    <table class="table mb-0">
      <thead>
        <tr>
          <th>Period</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for p in periods %}
        <tr>
          <td>{{ p }}</td>
          <td>
            <span class="badge bg-info">
              {{ p.status|title }}
            </span>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>
<hr>
<h2>Payroll Dashboard</h2>

<canvas id="monthlyPayrollChart" height="120"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
fetch("{% url 'payroll:monthly_payroll_chart' %}")
  .then(res => res.json())
  .then(data => {
    new Chart(document.getElementById("monthlyPayrollChart"), {
      type: "line",
      data: {
        labels: data.map(d => d.month),
        datasets: [{
          label: "Total Salary Paid",
          data: data.map(d => d.total),
          tension: 0.3
        }]
      }
    });
  });
</script>

{% endblock %}
