{% extends "base_auth.html" %}

{% block title %}Communication Center{% endblock title %}

{% block content %}
<div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8">
    
    <div class="bg-white rounded-xl shadow-lg border border-gray-100 flex flex-col h-[70vh]">
        <div class="p-4 border-b bg-blue-50 rounded-t-xl">
            <h2 class="text-xl font-bold text-blue-700">Staff/Admin Chat</h2>
            <p class="text-sm text-gray-500">Bi-directional messaging among staff and admins.</p>
        </div>
        
        <div id="staff-chat-log" class="flex-grow p-4 overflow-y-auto space-y-4">
            </div>
        
        <form id="staff-chat-form" class="p-4 border-t bg-gray-50">
            <div class="flex space-x-3">
                <input type="text" id="staff-chat-input" placeholder="Type staff message..." required
                       class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                <button type="submit" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    Send
                </button>
            </div>
        </form>
    </div>

    <div class="bg-white rounded-xl shadow-lg border border-gray-100 flex flex-col h-[70vh]">
        <div class="p-4 border-b bg-red-50 rounded-t-xl">
            <h2 class="text-xl font-bold text-red-700">Student Broadcast</h2>
            <p class="text-sm text-gray-500">Uni-directional announcements to all students.</p>
        </div>
        
        <div id="broadcast-log" class="flex-grow p-4 overflow-y-auto space-y-4">
            </div>
        
        <form id="broadcast-form" class="p-4 border-t bg-gray-50">
            <div class="flex space-x-3">
                <input type="text" id="broadcast-input" placeholder="Type announcement for students..." required
                       class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                <button type="submit" 
                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                    Broadcast
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
    const wsUrl = "{{ ws_url }}".replace('http', 'ws');
    const chatLog = document.getElementById('staff-chat-log');
    const broadcastLog = document.getElementById('broadcast-log');
    const staffForm = document.getElementById('staff-chat-form');
    const broadcastForm = document.getElementById('broadcast-form');
    
    const socket = new WebSocket(wsUrl);

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const sender = data.sender;
        const message = data.message;
        const type = data.type;

        const messageHtml = `<div class="${type === 'chat' ? 'text-gray-800' : 'text-red-700 font-medium'}">
            <span class="font-bold">${sender}:</span> ${message}
        </div>`;

        if (type === 'chat') {
            chatLog.innerHTML += messageHtml;
            chatLog.scrollTop = chatLog.scrollHeight; // Scroll to bottom
        } else if (type === 'broadcast') {
            broadcastLog.innerHTML += messageHtml;
            broadcastLog.scrollTop = broadcastLog.scrollHeight; // Scroll to bottom
        }
    };

    // Staff Chat Submission
    staffForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const input = document.getElementById('staff-chat-input');
        const message = input.value;
        socket.send(JSON.stringify({
            'type': 'chat',
            'message': message
        }));
        input.value = '';
    });

    // Student Broadcast Submission
    broadcastForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const input = document.getElementById('broadcast-input');
        const message = input.value;
        socket.send(JSON.stringify({
            'type': 'broadcast',
            'message': message
        }));
        input.value = '';
    });
</script>
{% endblock extra_js %} 