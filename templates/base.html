<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}The Brills School Portal{% endblock %}</title>


    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  

    <style>        
       
        .navbar {
            backdrop-filter: blur(8px);
        }

        .avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            object-fit: cover;
        }

        .fade-enter {
            animation: fade .4s ease-in;
        }

        @keyframes fade {
            from {
                opacity: 0;
                transform: translateY(4px)
            }

            to {
                opacity: 1
            }
        }
    </style>


<!--  /* For sidebar & cart */ -->

    <style>

.cart-sidebar.show {
    right: 0;
}

.cart-header {
    padding: 15px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
}

.cart-body {
    padding: 15px;
    overflow-y: auto;
    flex-grow: 1;
}

.cart-item {
    display: flex;
    gap: 10px;
    margin-bottom: 12px;
}

.cart-item img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 6px;
}

.qty-controls button {
    border: none;
    background: #eee;
    width: 28px;
    height: 28px;
}
</style>

<style>
/* Floating cart */
.floating-cart {
    position: fixed;
    bottom: 25px;
    right: 25px;
    background: #0d6efd;
    color: #fff;
    border: none;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    font-size: 22px;
    z-index: 1100;
    box-shadow: 0 10px 25px rgba(0,0,0,.25);
}

/* Badge */
.cart-badge {
    position: absolute;
    top: -6px;
    right: -6px;
    background: #dc3545;
    color: #fff;
    font-size: 12px;
    padding: 4px 7px;
    border-radius: 50%;
    animation: none;
}

/* Bounce */
.cart-badge.bump {
    animation: bump .4s ease;
}

@keyframes bump {
    0% { transform: scale(1); }
    30% { transform: scale(1.4); }
    100% { transform: scale(1); }
}

/* Sidebar */
.cart-sidebar {
    position: fixed;
    top: 0;
    right: -380px;
    width: 360px;
    height: 100vh;
    background: #fff;
    z-index: 1050;
    transition: right .35s cubic-bezier(.4,0,.2,1);
    box-shadow: -5px 0 25px rgba(0,0,0,.15);
    display: flex;
    flex-direction: column;
}

.cart-sidebar.show {
    right: 0;
}

.cart-header {
    padding: 15px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
}

.cart-body {
    padding: 15px;
    overflow-y: auto;
    flex-grow: 1;
}

#cart-overlay.show {
  opacity: 1;
  pointer-events: all;
}

#cart-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.45);
  z-index: 1040;
  opacity: 0;
  pointer-events: none;
  transition: opacity .25s ease;
}

body.cart-open {
  overflow: hidden;
}


.product-card {
  opacity: 0;
  transform: translateY(12px);
  animation: cardIn .45s ease forwards;
}

@keyframes cardIn {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

</style>
        
</head>

<body class="fade-enter">


    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#">The Brills School</a>


            <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#nav">
                <span class="navbar-toggler-icon"></span>
            </button>


            <div class="collapse navbar-collapse" id="nav">
                <ul class="navbar-nav ms-auto align-items-center gap-2">
                     {% if request.user.is_authenticated %}
                    <li class="nav-item text-white small me-2">{{ request.user.get_full_name }}</li>
                    <li class="nav-item">
                        <img src="{{ request.user.profile_picture.url|default:'/static/images/default_profile.png' }}"
                            class="avatar">
                    </li>
                    <li class="nav-item">
                        <a href="{% url 'accounts:logout' %}" class="btn btn-sm btn-light">Logout</a>
                    </li>
                    {% endif %}
            </div>
        </div>
    </nav>

     <div class="container">
            {% if messages %}
            <div class="row">
                <div class="col-12">
                    {% for message in messages %}
                        <div class="alert mt-3 alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

    <main class="container-fluid py-4">
        {% block content %}
       
        {% endblock %}
        
    </main>

    <div id="cart-overlay"></div>

    
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="appToast" class="toast align-items-center text-bg-primary border-0">
            <div class="d-flex">
            <div class="toast-body" id="toastMsg"></div>
            <button class="btn-close btn-close-white me-2 m-auto"
                    data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>
   
    <!-- CART SIDEBAR ROOT (always present) -->
    <div id="cartSidebar" class="cart-sidebar">
        <div class="cart-header">
            <h6 class="mb-0">Your Cart</h6>
            <button class="btn-close" onclick="toggleCart()"></button>
        </div>
        <div class="cart-body" id="cartBody">
            <p class="text-muted small text-center mt-4">Loading cart…</p>
        </div>
    </div>

    {% csrf_token %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>


<script>

const wardId = new URLSearchParams(window.location.search).get("ward");

function goBack(fallbackUrl) {
  if (window.history.length > 1) {
    window.history.back();
  } else {
    window.location.href = fallbackUrl;
  }
}


function closeCart() {
  document.getElementById("cartSidebar").classList.remove("show");
  document.getElementById("cart-overlay").classList.remove("show");
  document.body.classList.remove("cart-open");
  refreshCartCount()
}

document.getElementById("cart-overlay").addEventListener("click", closeCart);


function openCart() {
    loadCart();
    document.getElementById("cartSidebar").classList.add("show");
    document.getElementById("cart-overlay").classList.add("show");

}

function toggleCart() {
    document.getElementById("cartSidebar").classList.toggle("show");
    document.getElementById("cart-overlay").classList.remove("show");
    refreshCartCount()

}


/* Load cart content */
function loadCart() {
    fetch(`/brillspay/cart/sidebar/?ward=${wardId}`)
        .then(res => res.text())
        .then(html => {
            document.getElementById("cartBody").innerHTML = html;
        });
}


function updateQty(itemId, action) {
    fetch("/brillspay/cart/update/", {
        method: "POST",
        headers: {
            "X-CSRFToken": CSRF_TOKEN,
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: `item_id=${itemId}&action=${action}`
    }).then(() => {
        loadCart();
        refreshCartCount();
    });
}


function refreshCartCount() {

    if (!wardId) return;

    fetch(`/brillspay/cart/count/?ward=${wardId}`)
        .then(r => r.json())
        .then(data => {
            const badge = document.getElementById("cartCount");
            badge.innerText = data.count;
            badge.style.animation = "pop .3s ease";
        });
}

/* INITIAL LOAD */
refreshCartCount();

function removeItem(itemId) {
    fetch("/brillspay/cart/remove-item/", {
        method: "POST",
        headers: {
            "X-CSRFToken": CSRF_TOKEN,
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: `item_id=${itemId}`
    }).then(() => {
        loadCart();
        refreshCartCount();
        showToast("Item removed from cart", "warning");
    });
}

function clearCart() {
    fetch("/brillspay/cart/clear/", {
        method: "POST",
        headers: {
            "X-CSRFToken": CSRF_TOKEN,
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: `ward_id=${wardId}`
    }).then(() => {
        loadCart();
        refreshCartCount();
        toggleCart()
        showToast("Cart cleared", "danger");
    });
}


function showToast(message, type="primary") {
    const toastEl = document.getElementById("appToast");
    const msgEl = document.getElementById("toastMsg");

    toastEl.className = `toast align-items-center text-bg-${type} border-0`;
    msgEl.innerText = message;

    const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
    toast.show();
}


document.addEventListener("click", function(e){
  if (!e.target.classList.contains("btn-add-cart")) return;

  const btn = e.target;
  btn.disabled = true;
  btn.innerText = "Adding…";

  fetch("{% url 'brillspay:cart_add' %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": CSRF_TOKEN,
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: new URLSearchParams({
      product_id: btn.dataset.product,
      ward_id: btn.dataset.ward
    })
  })
  .then(res => res.json())
  .then(() => {
    btn.innerText = "Added ✓";
    refreshCartCount();
  })
  .catch(() => {
    btn.innerText = "Error";
    btn.disabled = false;
  });
});


function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith(name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

 CSRF_TOKEN = getCookie("csrftoken");


document.addEventListener("DOMContentLoaded", refreshCartCount);

// Swipr right on Mobile
let touchStartX = 0;

document.addEventListener("touchstart", e => {
  touchStartX = e.touches[0].clientX;
});

document.addEventListener("touchend", e => {
  const diff = e.changedTouches[0].clientX - touchStartX;
  if (diff > 80) closeCart(); // swipe right
});

</script>


</html>