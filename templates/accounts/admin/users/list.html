{% extends "exams/admin/dashboard.html" %}
{% block title %}User Management{% endblock %}

{% block content %}
<div class="container-fluid mt-4 mb-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>ðŸ‘¥ User Management</h4>
    <button class="btn btn-success btn-sm" id="bulkApproveBtn">
      Bulk Approve
    </button>
  </div>

  <!-- FILTERS -->
  <form class="row g-2 mb-3" method="get">
    <div class="col-md-3">
      <select name="role" class="form-select">
        <option value="">All Roles</option>
        <option value="student" {% if role == "student" %}selected{% endif %}>Student</option>
        <option value="parent" {% if role == "parent" %}selected{% endif %}>Parent</option>
        <option value="teacher" {% if role == "teacher" %}selected{% endif %}>Teacher</option>
        <option value="admin" {% if role == "admin" %}selected{% endif %}>Admin</option>
      </select>
    </div>

    <div class="col-md-3">
      <select name="status" class="form-select">
        <option value="">All Status</option>
        <option value="pending" {% if status == "pending" %}selected{% endif %}>Pending</option>
        <option value="approved" {% if status == "approved" %}selected{% endif %}>Approved</option>
      </select>
    </div>

    <div class="col-md-2">
      <button class="btn btn-primary w-100">Filter</button>
    </div>
  </form>

  <!-- USERS TABLE -->
  <form id="bulkForm">
    {% csrf_token %}
    <div class="table-responsive">
    <table class="table table-hover shadow-sm bg-white table-responsive">
      <thead class="table-light">
        <tr>
          <th><input type="checkbox" id="selectAll"></th>
          <th>Name</th>
          <th>Reg</th>
          <th>Email</th>
          <th>Role</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>

      <tbody>
        {% for user in users %}
        <tr>
          <td>
            {% if not user.is_approved %}
              <input type="checkbox" name="user_ids[]" value="{{ user.id }}">
            {% endif %}
          </td>
          <td>{{ user.get_full_name }}</td>
          <td>{{ user.admission_number }}</td>
          <td>{{ user.email }}</td>
          <td>{{ user.role|title }}</td>
          <td>
            {% if user.is_approved %}
              <span class="badge bg-success">Approved</span>
            {% else %}
              <span class="badge bg-warning">Pending</span>
            {% endif %}
          </td>
          <td>
            {% if not user.is_approved %}
              <a href="{% url 'accounts:approve_users'  %}"
                 class="btn btn-sm btn-outline-success">
                 Approve
              </a>
            {% else %}
              â€”
            {% endif %}
          </td>
          <td> 
            <a href="{% url 'accounts:complete_profile' %}" 
              class="btn btn-sm btn-outline-success">
              update
            </a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="text-center text-muted">No users found</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    </div>"
  </form>
</div>
<script>
document.getElementById("selectAll").addEventListener("change", function() {
  document.querySelectorAll("input[name='user_ids[]']").forEach(cb => {
    cb.checked = this.checked;
  });
});

document.getElementById("bulkApproveBtn").addEventListener("click", function() {
  let form = document.getElementById("bulkForm");
  let data = new FormData(form);

  fetch("{% url 'accounts:bulk_approve' %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}"
    },
    body: data
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      location.reload();
    }
  });
});
</script>

{% if page_obj.has_other_pages %}
  <nav class="mt-3">
    <ul class="pagination justify-content-center">

      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link"
            href="?page={{ page_obj.previous_page_number }}&role={{ role }}&status={{ status }}">
            Previous
          </a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Previous</span></li>
      {% endif %}

      {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
          <li class="page-item active"><span class="page-link">{{ num }}</span></li>
        {% else %}
          <li class="page-item">
            <a class="page-link"
              href="?page={{ num }}&role={{ role }}&status={{ status }}">
              {{ num }}
            </a>
          </li>
        {% endif %}
      {% endfor %}

      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link"
            href="?page={{ page_obj.next_page_number }}&role={{ role }}&status={{ status }}">
            Next
          </a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Next</span></li>
      {% endif %}
  </ul>
</nav>
{% endif %}
{% endblock %}
