{% extends "base.html" %}
{% block content %}
<div class="container mt-4">

  <h3>Welcome, {{ user.get_full_name }}</h3>

  <!-- Notifications Toast Container -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="notification-toast-container"></div>
  </div>

  <div class="row mt-4">

    <!-- Available Exams -->
    <div class="col-md-6 mb-4">
      <h5>Available Exams</h5>
      <div class="list-group">
        {% for exam in exams %}
          <a href="{% url 'take_exam' exam.id %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center {% if exam.id in attempted_exam_ids %}list-group-item-secondary{% endif %}">
            <div>
              <strong>{{ exam.title }}</strong><br>
              {{ exam.school_class.name }} | Duration: {{ exam.duration }} mins
            </div>
            <span>
              {% if exam.id in attempted_exam_ids %}
                {% if retakes_allowed_dict|default:{}|dict_get:exam.id %}
                  <span class="badge bg-warning">Retake Allowed</span>
                {% else %}
                  <span class="badge bg-success">Completed</span>
                {% endif %}
              {% else %}
                <span class="badge bg-primary">Take Exam</span>
              {% endif %}
            </span>
          </a>
        {% empty %}
          <p class="text-muted">No exams available currently.</p>
        {% endfor %}
      </div>
    </div>

    <!-- Performance Chart -->
    <div class="col-md-6 mb-4">
      <h5>Your Performance</h5>
      <canvas id="performanceChart"></canvas>
    </div>
  </div>

  <!-- Leaderboard -->
  <div class="row">
    <div class="col-12">
      <h5>Class Leaderboard</h5>
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Student</th>
            <th>Total Score</th>
          </tr>
        </thead>
        <tbody>
          {% for rank, entry in leaderboard %}
            <tr {% if entry.student.id == user.id %}class="table-info"{% endif %}>
              <td>{{ rank }}</td>
              <td>{{ entry.student.get_full_name }}</td>
              <td>{{ entry.total_score }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="3" class="text-muted text-center">No leaderboard data yet.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Chart.js for Performance -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('performanceChart').getContext('2d');
const labels = {{ performance_labels|safe }};  // e.g., ["Math", "English"]
const scores = {{ performance_scores|safe }};   // e.g., [85, 90]

new Chart(ctx, {
    type: 'bar',
    data: {
        labels: labels,
        datasets: [{
            label: 'Scores',
            data: scores,
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        scales: { y: { beginAtZero: true, max: 100 } }
    }
});
</script>

<!-- Notifications JS (async) -->
<script>
async function fetchNotifications() {
    const res = await fetch("{% url 'check_notifications' %}");
    const data = await res.json();
    const container = document.getElementById('notification-toast-container');

    data.notifications.forEach(n => {
        if (!document.getElementById('notif-'+n.id)) {
            const toast = document.createElement('div');
            toast.className = 'toast show';
            toast.id = 'notif-'+n.id;
            toast.setAttribute('role','alert');
            toast.innerHTML = `
                <div class="toast-header">
                    <strong class="me-auto">${n.title}</strong>
                    <small class="text-muted">${new Date(n.created_at).toLocaleTimeString()}</small>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">
                    ${n.message}
                    <div class="mt-2">
                        <a href="/exams/take/${n.related_exam_id}/" class="btn btn-sm btn-success">Resume Exam</a>
                    </div>
                </div>
            `;
            container.appendChild(toast);
        }
    });


    container.querySelectorAll('.mark-read').forEach(btn=>{
        btn.addEventListener('click', e=>{
            const id = btn.dataset.id;
            fetch(`/notifications/mark-read/${id}/`, {
                method:'POST',
                headers:{'X-CSRFToken':'{{ csrf_token }}'}
            }).then(res=>res.json()).then(d=>{
                if(d.status==='ok'){
                    const t = document.getElementById('notif-'+id);
                    t.remove();
                }
            });
        });
    });
}

setInterval(fetchNotifications, 10000);
fetchNotifications();

</script>
{% endblock %}
