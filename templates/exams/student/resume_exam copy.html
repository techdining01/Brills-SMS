{% extends "base.html" %}
{% load static %}

{% block content %}
{% include "partials/student_nav.html" %}

<div class="container py-4">

  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
      {{ attempt.exam.title }} - Time Remaining: <span id="timer">{{ attempt.remaining_seconds|divisibleby:60 }}:00</span>
    </div>
    <form method="post" action="{% url 'exams:submit_exam' attempt.id %}" id="examForm">
      {% csrf_token %}
      <div class="card-body">

        {% for question in questions %}
        <div class="mb-4 border p-3 rounded">
          <p><strong>Q{{ forloop.counter }}:</strong> {{ question.text }}</p>

          {% if question.type == 'objective' %}
            {% for choice in question.choice_set.all %}
            <div class="form-check">
              <input class="form-check-input" type="radio"
                     name="choice_{{ question.id }}"
                     value="{{ choice.id }}"
                     {% if answers|default:{}|dict_get:question.id and answers|dict_get:question.id.selected_choice.id == choice.id %}checked{% endif %}>
              <label class="form-check-label">{{ choice.text }}</label>
            </div>
            {% endfor %}
          {% else %}
            <textarea class="form-control" rows="3" name="q_{{ question.id }}">{{ answers|default:{}|dict_get:question.id.answer_text }}</textarea>
          {% endif %}

        </div>
        {% endfor %}

      </div>
      <div class="card-footer d-flex justify-content-between">
        <button type="submit" class="btn btn-success">Submit Exam</button>
      </div>
    </form>
  </div>

</div>

<script>
let remaining = {{ attempt.remaining_seconds }};
const timerEl = document.getElementById("timer");

function updateTimer() {
    if(remaining <= 0) {
        document.getElementById("examForm").submit();
    }
    let mins = Math.floor(remaining / 60);
    let secs = remaining % 60;
    timerEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
    remaining--;
}

setInterval(updateTimer, 1000);
</script>

{% endblock %}
