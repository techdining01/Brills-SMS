{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container py-4">

    <h3 class="mb-4">Student Dashboard</h3>

    <!-- Resume Interrupted Exams -->
    {% if resumable_exams %}
    <div class="mb-4">
        <h5>Resume Exam</h5>
        <ul class="list-group">
        {% for attempt in resumable_exams %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                {{ attempt.exam.title }} (Remaining: {{ attempt.remaining_seconds }} sec)
                <a href="{% url 'exams:start_exam' attempt.exam.id %}" class="btn btn-warning btn-sm">Resume</a>
            </li>
        {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- Available Exams -->
    <div class="mb-5">
        <h5>Available Exams</h5>
        {% if available_exams %}
            <ul class="list-group">
            {% for exam in available_exams %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    {{ exam.title }} ({{ exam.duration }} mins)
                    <a href="{% url 'exams:start_exam' exam.id %}" class="btn btn-primary btn-sm">Start Exam</a>
                </li>
            {% endfor %}
            </ul>
        {% else %}
            <p class="text-muted">No available exams at the moment.</p>
        {% endif %}
    </div>

    <!-- Leaderboards -->
    <div class="mb-5">
        <h5>Leaderboards</h5>
        {% for attempt in attempts %}
            {% if attempt.status == 'submitted' %}
            <div class="card mb-3">
                <div class="card-header">
                    {{ attempt.exam.title }} Leaderboard
                </div>
                <div class="card-body p-0">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Student</th>
                                <th>Score</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for row in leaderboard_data.attempt.exam.id %}
                            <tr {% if row.student.id == user.id %} class="table-success" {% endif %}>
                                <td>{{ row.rank }}</td>
                                <td>{{ row.student.get_full_name }}</td>
                                <td>{{ row.score }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        {% empty %}
            <p class="text-muted">No completed exams yet.</p>
        {% endfor %}
    </div>

    <!-- Chart: Scores -->
    <div>
        <h5>My Exam Scores</h5>
        <canvas id="scoreChart" width="400" height="150"></canvas>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('scoreChart').getContext('2d');
const scoreChart = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: {{ chart_labels|safe }},
        datasets: [{
            label: 'Score',
            data: {{ chart_scores|safe }},
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: { beginAtZero: true }
        }
    }
});
</script>

{% endblock %}
