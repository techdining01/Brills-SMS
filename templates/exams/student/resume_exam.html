{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h4>{{ exam.title }}</h4>
  <p>Time remaining: <span id="timer"></span></p>

  <form method="post">
    {% csrf_token %}
    {% for q in questions %}
      <div class="card my-3 p-3">
        <p><strong>{{ forloop.counter }}.</strong> {{ q.text }}</p>

        {% if q.type == 'objective' %}
          {% for choice in q.choice_set.all %}
            <div class="form-check">
              <input class="form-check-input" type="radio" name="choice_{{ q.id }}" value="{{ choice.id }}"
                     {% if choice.id == q.studentanswer_set.first.selected_choice.id %}checked{% endif %}>
              <label class="form-check-label">{{ choice.text }}</label>
            </div>
          {% endfor %}
        {% else %}
          <textarea class="form-control" name="answer_{{ q.id }}">{{ q.studentanswer_set.first.answer_text }}</textarea>
        {% endif %}
      </div>
    {% endfor %}

    <button type="submit" name="save" class="btn btn-secondary">Save Progress</button>
    <button type="submit" name="submit" class="btn btn-success">Submit Exam</button>
  </form>
</div>

<script>
let remaining = {{ remaining }};
const timerEl = document.getElementById('timer');

function updateTimer() {
    let minutes = Math.floor(remaining/60);
    let seconds = remaining % 60;
    timerEl.innerText = minutes + ":" + (seconds < 10 ? "0"+seconds : seconds);
    if (remaining <= 0) document.querySelector("form").submit();
    remaining--;
}
setInterval(updateTimer, 1000);
</script>
{% endblock %}
