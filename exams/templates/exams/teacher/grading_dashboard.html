{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <h3>Teacher Grading Dashboard</h3>
    <table class="table table-hover mt-3">
        <thead>
            <tr>
                <th>Student</th>
                <th>Exam</th>
                <th>Question</th>
                <th>Answer</th>
                <th>Marks</th>
            </tr>
        </thead>
        <tbody>
            {% for ans in answers %}
            <tr id="answer-{{ ans.id }}">
                <td>{{ ans.attempt.student.get_full_name }}</td>
                <td>{{ ans.question.exam.title }}</td>
                <td>{{ ans.question.text }}</td>
                <td>{{ ans.answer_text }}</td>
                <td>
                    <input type="number" class="form-control form-control-sm score-input"
                           data-id="{{ ans.id }}"
                           value="{{ ans.subjectivemark.score|default:'' }}" min="0" max="{{ ans.question.marks }}">
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" class="text-center text-muted">No subjective answers to grade.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
document.querySelectorAll('.score-input').forEach(input => {
    input.addEventListener('change', e => {
        const score = input.value;
        const answerId = input.dataset.id;

        fetch(`/teacher/grade/save/${answerId}/`, {
            method: 'POST',
            headers: {'X-CSRFToken':'{{ csrf_token }}'},
            body: new URLSearchParams({'score': score})
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'ok'){
                input.value = data.score;
                input.classList.add('is-valid');
                setTimeout(()=>input.classList.remove('is-valid'), 1500);
            } else {
                alert(data.msg);
                input.classList.add('is-invalid');
                setTimeout(()=>input.classList.remove('is-invalid'), 1500);
            }
        });
    });
});
</script>
{% endblock %}
