{% extends "base.html" %}
{% block content %}
<h3>All Loan Applications</h3>

<canvas id="loanChart" width="400" height="200"></canvas>

<table class="table table-striped">
    <thead>
        <tr>
            <th>Payee</th>
            <th>Loan Type</th>
            <th>Amount</th>
            <th>Outstanding</th>
            <th>Status</th>
            <th>Applied At</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
    {% for loan in loans %}
        <tr>
            <td>{{ loan.payee.user.get_full_name }}</td>
            <td>{{ loan.loan_type }}</td>
            <td>{{ loan.loan_amount }}</td>
            <td>{{ loan.outstanding_balance }}</td>
            <td>{{ loan.status }}</td>
            <td>{{ loan.applied_at }}</td>
            <td>
                <a href="{% url 'loans:admin_loan_detail' loan.id %}" class="btn btn-sm btn-primary">View</a>
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>

<nav aria-label="Page navigation">
  <ul class="pagination">
    {% if loans.has_previous %}
      <li class="page-item"><a class="page-link" href="?page={{ loans.previous_page_number }}">Previous</a></li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Previous</span></li>
    {% endif %}

    {% for num in loans.paginator.page_range %}
      <li class="page-item {% if loans.number == num %}active{% endif %}">
        <a class="page-link" href="?page={{ num }}">{{ num }}</a>
      </li>
    {% endfor %}

    {% if loans.has_next %}
      <li class="page-item"><a class="page-link" href="?page={{ loans.next_page_number }}">Next</a></li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Next</span></li>
    {% endif %}
  </ul>
</nav>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('loanChart').getContext('2d');
    const loanChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Approved', 'Pending', 'Rejected'],
            datasets: [{
                label: 'Loans',
                data: [{{ total_approved }}, {{ total_pending }}, {{ loans|length }} - {{ total_approved }} - {{ total_pending }}],
                backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
            }]
        },
    });
</script>
{% endblock %}
