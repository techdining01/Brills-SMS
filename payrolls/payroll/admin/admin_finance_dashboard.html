{% extends "base.html" %}
{% load humanize %}
{% block content %}
<div class="container mt-4 mb-4 d-flex justify-content-between align-items-center">
  <h2 class="mb-4">Finance Control Center</h2>
  <div>
    <a class="btn btn-sm btn-outline-primary" href="{% url 'payroll:payee_list' %}">
      Payee +
    </a>
  </div>
</div>
<!-- ================= OVERVIEW ================= -->
<div class="row mb-4">
  <div class="col-md-4">
    <div class="card p-3">
      <h6>Total Payroll Net</h6>
      <h4>₦{{ payroll_totals.net|default_if_none:"0.00"|intcomma }}</h4>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card p-3">
      <h6>Total Loans Issued</h6>
      <h4>₦{{ loan_totals.total_loans|default_if_none:"0.00"|intcomma}}</h4>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card p-3">
      <h6>Outstanding Loans</h6>
      <h4 class="text-danger">
        ₦{{ loan_totals.outstanding|default_if_none:"0.00"|intcomma }}
      </h4>
    </div>
  </div>
</div>

<div class="card-body table-responsive">
  <!-- ================= TABS ================= -->
  <ul class="nav nav-tabs" role="tablist">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#periods">Payroll Periods</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#records">Payroll Records</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#batches">Payment Batches</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#loans">Loans</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#audits">Audit Logs</a></li>
  </ul>

  <div class="tab-content mt-3">

    <!-- ================= PERIODS ================= -->

    <div class="tab-pane fade show active" id="periods">
      <table class="table table-sm">
        <tr>
          <th>Period</th>
          <th>Status</th>
          <th>Action</th>
          <th>Payees</th>
          <th>More</th>
        </tr>
        {% for p in periods %}
        <tr>
          <td>{{ p.month }}/{{ p.year }}</td>
          <td>
            {% if p.is_paid %}Paid
            {% elif p.is_approved %}Approved
            {% elif p.is_generated %}Generated
            {% else %}Draft{% endif %}
          </td>
          <td><a href="{% url 'payroll:generate_payroll_for_period' p.id %}">Generate</a></td>
          <td><a href="{% url 'payroll:payroll_period_list' %}">List</a></td>
          <td><a href="{% url 'payroll:payroll_period_detail' p.id %}">Details</a></td>
        </tr>
        {% endfor %}
      </table>

      {% if periods.has_other_pages %}
      <ul class="pagination pagination-sm justify-content-center">
        {% for num in periods.paginator.page_range %}
        <li class="page-item {% if periods.number == num %}active{% endif %}">
          <a class="page-link" href="?period_page={{ num }}&tab=periods">
            {{ num }}
          </a>
        </li>
        {% endfor %}
      </ul>
      {% endif %}
    </div>

    <!-- ================= RECORDS ================= -->
    <div class="tab-pane fade" id="records">
      <table class="table table-sm">
        <tr>
          <th>Period</th>
          <th>Payee</th>
          <th>Net Pay</th>
          <th>Deduction</th>
          <th>Status</th>
          <th>More</th>
          <th>Detail</th>
        </tr>
        {% for r in records %}
        <tr>
          <td>{{ r.payroll_period }}</td>
          <td>{{ r.payee }}</td>
          <td>₦{{ r.net_pay|default_if_none:"0.00"|intcomma }}</td>
          <td>₦{{ r.total_deductions|default_if_none:"0.00"|intcomma }}</td>
          <td>{% if r.generated %}Generated</td>
          <td>{% else %}Approved</td>{% endif %}
          <td><a href="{% url 'payroll:payroll_record_list' %}">Full List</a></td>
          <td><a href="{% url 'payroll:payroll_record_detail' r.id %}">Detail</a></td>
        </tr>
        {% endfor %}
      </table>

      {% if records.has_other_pages %}
      <ul class="pagination pagination-sm justify-content-center">
        {% for num in records.paginator.page_range %}
        <li class="page-item {% if records.number == num %}active{% endif %}">
          <a class="page-link" href="?record_page={{ num }}&tab=records">
            {{ num }}
          </a>
        </li>
        {% endfor %}
      </ul>
      {% endif %}
    </div>

    <!-- ================= BATCHES ================= -->
    <div class="tab-pane fade" id="batches">
      <table class="table table-sm table-responsive">
        <tr>
          <th>Batch Ref</th>
          <th>Status</th>
          <th>More</th>
          <th>Date</th>
        </tr>
        {% for b in batches %}
        <tr>
          <td>{{ b.payroll_period }}</td>
          {% if b.is_processed %}
          <td>Processed</td>{% else %}
          <td>Pending</td>
          {% endif %}
          <td><a href="{% url 'payroll:batch_detail' b.id %}">Details</a></td>
          <td>{{ b.created_at }}</td>
        </tr>
        {% endfor %}
      </table>
      <p class="text-muted small">
        Page {{ batches.number }} of {{ batches.paginator.num_pages }}
      </p>
      {% if batches.has_other_pages %}
      <nav>
        <ul class="pagination pagination-sm justify-content-center">

          {% if batches.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?batches_page={{ batches.previous_page_number }}#batches">
              Previous
            </a>
          </li>
          {% endif %}
          {% for num in batches.paginator.page_range %}
          {% if batches.number == num %}
          <li class="page-item active">
            <span class="page-link">{{ num }}</span>
          </li>
          {% else %}
          <li class="page-item">
            <a class="page-link" href="?batches_page={{ num }}#batches">
              {{ num }}
            </a>
          </li>
          {% endif %}
          {% endfor %}

          {% if batches.has_next %}
          <li class="page-item">
            <a class="page-link" href="?batches_page={{ batches.next_page_number }}#batches">
              Next
            </a>
          </li>
          {% endif %}

        </ul>
      </nav>
      {% endif %}

    </div>

    <!-- ================= LOANS ================= -->
    <div class="tab-pane fade" id="loans">
      <table class="table table-sm table-responsive">
        <tr>
          <th>Payee</th>
          <th>Amount</th>
          <th>Outstanding</th>
          <th>Tenure Months</th>
          <th>Status</th>
          <th>Approval</th>
          <th>Denial</th>
        </tr>
        {% for l in loans %}
        <tr>
          <td>{{ l.payee.user.get_full_name }}</td>
          <td>₦{{ l.loan_amount|default_if_none:"0.00"|intcomma }}</td>
          <td>₦{{ l.outstanding_balance|default_if_none:"0.00"|intcomma }}</td>
          <td>{{ l.tenure_months }}</td>
          <td>{{ l.status }}</td>
          <td><a href="{% url 'loans:approve_loan' l.id %}">Approve</a></td>
          <td><a href="{% url 'loans:reject_loan' l.id %}">Reject</a></td>
        </tr>
        {% endfor %}
      </table>
      <p class="text-muted small">
        Page {{ loans.number }} of {{ loans.paginator.num_pages }}
      </p>

      {% if loans.has_other_pages %}
      <nav>
        <ul class="pagination pagination-sm justify-content-center">

          {% if loans.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?loans_page={{ loans.previous_page_number }}#loans">
              Previous
            </a>
          </li>
          {% endif %}
          {% for num in loans.paginator.page_range %}
          {% if loans.number == num %}
          <li class="page-item active">
            <span class="page-link">{{ num }}</span>
          </li>
          {% else %}
          <li class="page-item">
            <a class="page-link" href="?loans_page={{ num }}#loans">
              {{ num }}
            </a>
          </li>
          {% endif %}
          {% endfor %}

          {% if loans.has_next %}
          <li class="page-item">
            <a class="page-link" href="?loans_page={{ loans.next_page_number }}#loans">
              Next
            </a>
          </li>
          {% endif %}

        </ul>
      </nav>
      {% endif %}

    </div>

    <!-- ================= AUDIT ================= -->
    <div class="tab-pane fade" id="audits">
      <table class="table table-sm table-responsive">
        <tr>
          <th>User</th>
          <th>Action</th>
          <th>Object</th>
          <th>Date</th>
        </tr>
        {% for a in audits %}
        <tr>
          <td>{{ a.user }}</td>
          <td>{{ a.action }}</td>
          <td>{{ a.object_type }}</td>
          <td>{{ a.created_at }}</td>
        </tr>
        {% endfor %}
      </table>
      <p class="text-muted small">
        Page {{ audits.number }} of {{ audits.paginator.num_pages }}
      </p>
      {% if audits.has_other_pages %}
      <nav>
        <ul class="pagination pagination-sm justify-content-center">

          {% if audits.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?audits_page={{ audits.previous_page_number }}#audits">
              Previous
            </a>
          </li>
          {% endif %}
          {% for num in audits.paginator.page_range %}
          {% if audits.number == num %}
          <li class="page-item active">
            <span class="page-link">{{ num }}</span>
          </li>
          {% else %}
          <li class="page-item">
            <a class="page-link" href="?audits_page={{ num }}#audits">
              {{ num }}
            </a>
          </li>
          {% endif %}
          {% endfor %}

          {% if audits.has_next %}
          <li class="page-item">
            <a class="page-link" href="?audits_page={{ audits.next_page_number }}#audits">
              Next
            </a>
          </li>
          {% endif %}

        </ul>
      </nav>
      {% endif %}

    </div>
    {% endblock %}

    {% if page_obj.has_other_pages %}
    <nav>
      <ul class="pagination pagination-sm justify-content-center">

        {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?{{ page_param }}={{ page_obj.previous_page_number }}&tab={{ tab_id }}">
            Previous
          </a>
        </li>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
        <li class="page-item active">
          <span class="page-link">{{ num }}</span>
        </li>
        {% else %}
        <li class="page-item">
          <a class="page-link" href="?{{ page_param }}={{ num }}&tab={{ tab_id }}">
            {{ num }}
          </a>
        </li>
        {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?{{ page_param }}={{ page_obj.next_page_number }}&tab={{ tab_id }}">
            Next
          </a>
        </li>
        {% endif %}

      </ul>
    </nav>
    {% endif %}

  </div>