{% extends "base.html" %}
{% load humanize %}

{% block content %}
<div class="container py-4">

  <!-- Header -->
  <div class="mb-4">
    <h4 class="fw-bold">Checkout</h4>
    <small class="text-muted">
      Review your order before payment
    </small>
  </div>

  <div class="row g-4">

    <!-- Left: Customer / Payment -->
    <div class="col-lg-7">

      <!-- Customer Info -->
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
          <h6 class="fw-bold mb-3">Customer Details</h6>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Full Name</label>
              <input type="text" class="form-control"
                     value="{{ request.user.get_full_name }}"
                     readonly>
            </div>

            <div class="col-md-6">
              <label class="form-label">Email</label>
              <input type="email" class="form-control"
                     value="{{ request.user.email }}"
                     readonly>
            </div>
          </div>
        </div>
      </div>

      <!-- Payment -->
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h6 class="fw-bold mb-3">Payment Method</h6>

          <div class="alert alert-info small">
            Secure payment powered by <strong>Paystack</strong>
          </div>

          <button id="payBtn"
                  class="btn btn-primary btn-lg w-100">
            Pay ₦{{ cart.subtotal|intcomma }}
          </button>

          <small class="text-muted d-block mt-2 text-center">
            You will be redirected to complete payment
          </small>
        </div>
      </div>

    </div>

    <!-- Right: Order Summary -->
    <div class="col-lg-5">
      <div class="card shadow-sm border-0">
        <div class="card-body">

          <h6 class="fw-bold mb-3">Order Summary</h6>

          {% for item in cart_items %}
          <div class="d-flex justify-content-between mb-2">
            <div>
              {{ item.product.name }}
              <small class="text-muted">
                × {{ item.quantity }}
              </small>
            </div>
            <strong>
              ₦{{ item.get_total_price|intcomma }}
            </strong>
          </div>
          {% endfor %}

          <hr>

          <div class="d-flex justify-content-between">
            <span>Total</span>
            <strong class="fs-5">
              ₦{{ cart.subtotal|intcomma }}
            </strong>
          </div>

        </div>
      </div>
    </div>

  </div>
</div>

<!-- Paystack -->
<script src="https://js.paystack.co/v1/inline.js"></script>
<script>
document.getElementById("payBtn").onclick = function () {
  let handler = PaystackPop.setup({
    key: "{{ PAYSTACK_PUBLIC_KEY }}",
    email: "{{ request.user.email }}",
    amount: {{ cart.subtotal }} * 100,
    currency: "NGN",
    ref: "{{ reference }}",
    callback: function (response) {
      window.location.href =
        "{% url 'brillspay:payment_callback' %}?ref=" + response.reference
    },
    onClose: function () {
      alert("Payment window closed");
    }
  })
  handler.openIframe()
}

async function updateCart(productId, action) {
  const res = await fetch("/brillspay/cart/update/", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}"
    },
    body: new URLSearchParams({
      product_id: productId,
      action: action
    })
  })
  return await res.json()
}
document.querySelectorAll(".qty-btn").forEach(btn => {
  btn.onclick = async () => {
    const productId = btn.dataset.id
    const action = btn.dataset.action
    const data = await updateCart(productId, action)
    if (data.success) {
      location.reload()
    }
  }
})
</script>
{% endblock %}
