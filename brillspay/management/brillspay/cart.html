{% extends "base.html" %}
{% load humanize %}

{% block content %}
<div class="container py-4">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold mb-0">üõí Your Cart</h4>
    <a href="{% url 'brillspay:product_list' %}" class="btn btn-link">
      ‚Üê Continue Shopping
    </a>
  </div>

  {% if cart_items %}
  <div class="row g-4">

    <!-- Cart Items -->
    <div class="col-lg-8">
      <div class="card shadow-sm border-0">
        <div class="card-body">

          {% for item in cart_items %}
          <div class="row align-items-center py-3 border-bottom">
            <div class="col-3 col-md-2">
              {% if item.product.image %}
              <img src="{{ item.product.image.url }}"
                   class="img-fluid rounded">
              {% else %}
              <div class="bg-light rounded text-center py-4">
                <i class="bi bi-image text-muted"></i>
              </div>
              {% endif %}
            </div>

            <div class="col-9 col-md-4">
              <h6 class="mb-1">{{ item.product.name }}</h6>
              <small class="text-muted">
                ‚Ç¶{{ item.product.price|intcomma }}
              </small>
            </div>

            <div class="col-6 col-md-3 mt-3 mt-md-0">
              <div class="input-group input-group-sm">
                <button class="btn btn-outline-secondary qty-btn"
                        data-action="decrease"
                        data-id="{{ item.id }}">‚àí</button>

                <input type="text"
                       class="form-control text-center"
                       value="{{ item.quantity }}"
                       readonly>

                <button class="btn btn-outline-secondary qty-btn"
                        data-action="increase"
                        data-id="{{ item.id }}">+</button>
              </div>
            </div>

            <div class="col-4 col-md-2 text-end mt-3 mt-md-0">
              <strong>
                ‚Ç¶{{ item.get_total_price|intcomma }}
              </strong>
            </div>

            <div class="col-2 text-end mt-3 mt-md-0">
              <button class="btn btn-sm btn-link text-danger remove-item"
                      data-id="{{ item.id }}">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
          {% endfor %}

        </div>
      </div>
    </div>

    <!-- Summary -->
    <div class="col-lg-4">
      <div class="card shadow-sm border-0">
        <div class="card-body">

          <h6 class="fw-bold mb-3">Order Summary</h6>

          <div class="d-flex justify-content-between mb-2">
            <span>Subtotal</span>
            <strong>‚Ç¶{{ cart.subtotal|intcomma }}</strong>
          </div>

          <div class="d-flex justify-content-between mb-3">
            <span>Total</span>
            <strong class="fs-5">
              ‚Ç¶{{ cart.subtotal|intcomma }}
            </strong>
          </div>

          <a href="{% url 'brillspay:checkout' %}"
             class="btn btn-primary w-100">
            Proceed to Checkout
          </a>

        </div>
      </div>
    </div>

  </div>

  {% else %}
  <!-- Empty Cart -->
  <div class="text-center py-5">
    <i class="bi bi-cart-x fs-1 text-muted"></i>
    <p class="mt-3 text-muted">Your cart is empty</p>
    <a href="{% url 'brillspay:product_list' %}" class="btn btn-primary">
      Start Shopping
    </a>
  </div>
  {% endif %}
</div>

<script>
const csrftoken = '{{ csrf_token }}'

async function updateCart(url, data = {}) {
  const res = await fetch(url, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrftoken,
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: new URLSearchParams(data)
  })
  if (res.ok) location.reload()
}

document.querySelectorAll('.qty-btn').forEach(btn => {
  btn.onclick = () => {
    updateCart(
      "{% url 'brillspay:update_cart' %}",
      {
        item_id: btn.dataset.id,
        action: btn.dataset.action
      }
    )
  }
})

document.querySelectorAll('.remove-item').forEach(btn => {
  btn.onclick = () => {
    updateCart(
      "{% url 'brillspay:remove_from_cart' %}",
      { item_id: btn.dataset.id }
    )
  }
})
</script>
{% endblock %}
