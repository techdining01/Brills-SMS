{% extends "adminpanel/dashboard.html" %}
{% block title %}User Management{% endblock %}

{% block content %}
<div class="container-fluid mt-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>ðŸ‘¥ User Management</h4>
    <button class="btn btn-success btn-sm" id="bulkApproveBtn">
      Bulk Approve
    </button>
  </div>

  <!-- FILTERS -->
  <form class="row g-2 mb-3">
    <div class="col-md-3">
      <select name="role" class="form-select">
        <option value="">All Roles</option>
        <option value="student">Student</option>
        <option value="parent">Parent</option>
        <option value="teacher">Teacher</option>
        <option value="admin">Admin</option>
      </select>
    </div>

    <div class="col-md-3">
      <select name="status" class="form-select">
        <option value="">All Status</option>
        <option value="pending">Pending</option>
        <option value="approved">Approved</option>
      </select>
    </div>

    <div class="col-md-2">
      <button class="btn btn-primary w-100">Filter</button>
    </div>
  </form>

  <!-- USERS TABLE -->
  <form id="bulkForm">
    {% csrf_token %}
    <table class="table table-hover shadow-sm bg-white">
      <thead class="table-light">
        <tr>
          <th><input type="checkbox" id="selectAll"></th>
          <th>Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for user in users %}
        <tr>
          <td>
            {% if not user.is_approved %}
              <input type="checkbox" name="user_ids[]" value="{{ user.id }}">
            {% endif %}
          </td>
          <td>{{ user.get_full_name }}</td>
          <td>{{ user.email }}</td>
          <td>{{ user.role|title }}</td>
          <td>
            {% if user.is_approved %}
              <span class="badge bg-success">Approved</span>
            {% else %}
              <span class="badge bg-warning">Pending</span>
            {% endif %}
          </td>
          <td>
            {% if not user.is_approved %}
              <a href="{% url 'accounts:approve_user' user.id %}"
                 class="btn btn-sm btn-outline-success">
                 Approve
              </a>
            {% else %}
              â€”
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="text-center text-muted">No users found</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </form>
</div>

<script>
document.getElementById("selectAll").addEventListener("change", function() {
  document.querySelectorAll("input[name='user_ids[]']").forEach(cb => {
    cb.checked = this.checked;
  });
});

document.getElementById("bulkApproveBtn").addEventListener("click", function() {
  let form = document.getElementById("bulkForm");
  let data = new FormData(form);

  fetch("{% url 'accounts:bulk_approve_users' %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}"
    },
    body: data
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      location.reload();
    }
  });
});
</script>
{% endblock %}
